<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PromoZone - Premium Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <style>
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .sidebar-link.active { background-color: #4f46e5; color: white; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 font-sans flex h-screen overflow-hidden relative">

    <div id="auth-section" class="fixed inset-0 bg-gray-900 z-50 flex items-center justify-center p-4">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-md">
            <h2 class="text-3xl font-extrabold mb-2 text-center text-indigo-600">PromoZone</h2>
            <p class="text-center text-gray-500 mb-6">Login or create an account</p>
            <input type="email" id="email" placeholder="Email Address" class="w-full border border-gray-300 p-3 mb-4 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none">
            <input type="password" id="password" placeholder="Password" class="w-full border border-gray-300 p-3 mb-6 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none">
            <div class="flex gap-4">
                <button onclick="login()" class="bg-indigo-600 text-white font-bold py-3 rounded-lg w-1/2 hover:bg-indigo-700 transition">Login</button>
                <button onclick="signup()" class="bg-gray-800 text-white font-bold py-3 rounded-lg w-1/2 hover:bg-gray-900 transition">Signup</button>
            </div>
        </div>
    </div>

    <div id="sidebar-overlay" onclick="toggleSidebar()" class="fixed inset-0 bg-black/50 z-30 hidden md:hidden"></div>

    <aside id="sidebar" class="fixed md:static inset-y-0 left-0 w-64 bg-white shadow-xl h-full flex flex-col z-40 transform -translate-x-full md:translate-x-0 transition-transform duration-300 hidden">
        <div class="p-6 border-b flex justify-between items-center">
            <h1 class="text-2xl font-black text-indigo-600 tracking-tight"><i class="fa-solid fa-rocket mr-2"></i>PromoZone</h1>
            <button onclick="toggleSidebar()" class="md:hidden text-gray-500 text-2xl"><i class="fa-solid fa-xmark"></i></button>
        </div>
        <nav class="flex-1 p-4 space-y-2 overflow-y-auto">
            <button onclick="switchTab('home')" id="nav-home" class="sidebar-link active w-full flex items-center text-left p-3 rounded-lg font-semibold text-gray-600 hover:bg-indigo-50 hover:text-indigo-600 transition"><i class="fa-solid fa-fire w-6"></i> Campaigns</button>
            <button onclick="switchTab('account')" id="nav-account" class="sidebar-link w-full flex items-center text-left p-3 rounded-lg font-semibold text-gray-600 hover:bg-indigo-50 hover:text-indigo-600 transition"><i class="fa-solid fa-user-link w-6"></i> Link Account</button>
            <button onclick="switchTab('activity')" id="nav-activity" class="sidebar-link w-full flex items-center text-left p-3 rounded-lg font-semibold text-gray-600 hover:bg-indigo-50 hover:text-indigo-600 transition"><i class="fa-solid fa-chart-line w-6"></i> My Activity</button>
            <button onclick="switchTab('wallet')" id="nav-wallet" class="sidebar-link w-full flex items-center text-left p-3 rounded-lg font-semibold text-gray-600 hover:bg-indigo-50 hover:text-indigo-600 transition"><i class="fa-solid fa-wallet w-6"></i> Wallet & Payout</button>
        </nav>
        <div class="p-4 border-t">
            <button onclick="logout()" class="w-full flex items-center text-left p-3 rounded-lg font-semibold text-red-600 hover:bg-red-50 transition"><i class="fa-solid fa-sign-out-alt w-6"></i> Logout</button>
        </div>
    </aside>

    <main id="main-content" class="flex-1 overflow-y-auto hidden h-full w-full">
        <header class="bg-white shadow-sm p-4 flex justify-between items-center sticky top-0 z-20">
            <div class="flex items-center gap-3">
                <button onclick="toggleSidebar()" class="md:hidden text-gray-600 text-2xl"><i class="fa-solid fa-bars"></i></button>
                <h2 class="text-xl font-bold text-gray-800" id="header-title">Live Campaigns</h2>
            </div>
            <div class="flex items-center gap-3">
                <span class="text-xs md:text-sm text-gray-500 hidden sm:block" id="user-email-display"></span>
                <div class="bg-green-100 text-green-800 px-3 py-1.5 md:px-4 md:py-2 rounded-full font-bold shadow-sm text-sm md:text-base">
                    <i class="fa-solid fa-indian-rupee-sign mr-1"></i><span id="header-wallet">0.00</span>
                </div>
            </div>
        </header>

        <div class="p-4 md:p-8 max-w-7xl mx-auto">
            <div id="alert-box" class="hidden mb-6 p-4 rounded-lg font-semibold text-center z-50 fixed top-4 left-1/2 transform -translate-x-1/2 w-[90%] md:w-auto shadow-xl"></div>

            <div id="tab-home" class="tab-content active">
                <div id="campaigns-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
            </div>

            <div id="tab-account" class="tab-content max-w-2xl mx-auto">
                <div class="bg-white p-6 md:p-8 rounded-2xl shadow-sm border border-gray-100">
                    <h3 class="text-xl md:text-2xl font-bold mb-6 text-gray-800">Instagram Account Linking</h3>
                    <div id="step-1" class="space-y-4">
                        <label class="block text-sm font-semibold text-gray-600">Instagram Profile Link</label>
                        <input type="url" id="ig-url" placeholder="https://instagram.com/yourusername" class="w-full border p-3 rounded-lg outline-none focus:ring-2 focus:ring-indigo-500">
                        <button onclick="submitIgLink()" class="w-full bg-indigo-600 text-white font-bold py-3 rounded-lg shadow-lg">Submit Profile</button>
                    </div>
                    <div id="step-2" class="hidden bg-yellow-50 border border-yellow-200 p-6 rounded-xl text-center">
                        <i class="fa-solid fa-clock text-4xl text-yellow-500 mb-3"></i><br>
                        <span class="font-bold text-yellow-800">Under Review</span>
                        <p class="text-yellow-700 mt-2 text-sm">Please wait 2-3 hours for admin approval.</p>
                    </div>
                    <div id="step-3" class="hidden bg-indigo-50 border border-indigo-200 p-6 rounded-xl text-center">
                        <span class="font-bold text-indigo-800">Action Required</span>
                        <p class="text-gray-600 text-sm mb-4">Put this code exactly in your Instagram Bio, then verify.</p>
                        <div class="bg-white text-2xl md:text-3xl font-mono py-2 px-4 rounded-lg border-2 border-indigo-300 inline-block mb-4 text-indigo-700" id="secret-code"></div>
                        <button onclick="verifyCode()" id="verify-btn" class="w-full bg-green-500 text-white font-bold py-3 rounded-lg shadow-lg">I have added it, Verify Now</button>
                        <p id="verify-loading" class="hidden text-indigo-600 font-bold mt-3 animate-pulse">Verifying profile...</p>
                    </div>
                    <div id="step-4" class="hidden bg-green-50 border border-green-200 p-6 rounded-xl text-center">
                        <i class="fa-solid fa-circle-check text-5xl text-green-500 mb-3"></i><br>
                        <span class="text-xl font-bold text-green-800">Account Linked Successfully!</span>
                    </div>
                </div>
            </div>

            <div id="tab-activity" class="tab-content">
                <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-x-auto">
                    <table class="w-full text-left whitespace-nowrap">
                        <thead class="bg-gray-50 border-b">
                            <tr>
                                <th class="p-4 font-semibold text-gray-600">Reel Link</th>
                                <th class="p-4 font-semibold text-gray-600">Campaign</th>
                                <th class="p-4 font-semibold text-gray-600">Views</th>
                                <th class="p-4 font-semibold text-gray-600 text-right">Earning Calculated</th>
                                <th class="p-4 font-semibold text-gray-600 text-center">Status</th>
                            </tr>
                        </thead>
                        <tbody id="my-reels-list" class="divide-y text-sm md:text-base"></tbody>
                    </table>
                </div>
            </div>

            <div id="tab-wallet" class="tab-content max-w-2xl mx-auto">
                <div class="bg-gradient-to-r from-indigo-600 to-purple-600 rounded-2xl p-6 md:p-8 text-white shadow-xl mb-8 relative overflow-hidden">
                    <p class="text-indigo-100 font-semibold mb-1">Available Balance</p>
                    <h2 class="text-4xl md:text-5xl font-black mb-4">₹<span id="wallet-huge">0.00</span></h2>
                    <p class="text-xs md:text-sm bg-black/20 inline-block px-3 py-1 rounded-full"><i class="fa-solid fa-circle-info mr-1"></i> Min withdrawal ₹4000</p>
                </div>

                <div class="bg-white p-6 md:p-8 rounded-2xl shadow-sm border border-gray-100">
                    <h3 class="text-xl font-bold mb-4">Request UPI Withdrawal</h3>
                    <label class="block text-sm font-semibold text-gray-600 mb-1">Withdrawal Amount (₹)</label>
                    <input type="number" id="withdraw-amount" placeholder="Enter Amount (Min 4000)" class="w-full border p-3 rounded-lg mb-4 outline-none focus:ring-2 focus:ring-indigo-500 text-lg font-bold">
                    <label class="block text-sm font-semibold text-gray-600 mb-1">Your UPI ID</label>
                    <input type="text" id="upi-id" placeholder="e.g. 9876543210@ybl" class="w-full border p-3 rounded-lg mb-6 outline-none focus:ring-2 focus:ring-indigo-500">
                    <button onclick="requestWithdrawal()" class="w-full bg-gray-900 text-white font-bold py-3 rounded-lg hover:bg-black transition shadow-lg">Submit Withdrawal Request</button>
                </div>
            </div>

        </div>
    </main>

    <script>
        // PAST YOUR FIREBASE CONFIG HERE
        const firebaseConfig = {
        apiKey: "AIzaSyAb7V8Xxg5rUYi8UKChEd3rR5dglJ6bLhU",
        authDomain: "t2-storage-4e5ca.firebaseapp.com",
        databaseURL: "https://t2-storage-4e5ca-default-rtdb.firebaseio.com",
        projectId: "t2-storage-4e5ca"
    };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();

        let currentUser = null;
        let userData = null;

        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('-translate-x-full');
            document.getElementById('sidebar-overlay').classList.toggle('hidden');
        }

        function showAlert(msg, type = 'error') {
            const box = document.getElementById('alert-box');
            box.innerText = msg;
            box.className = `p-4 rounded-lg font-semibold text-white ${type === 'error' ? 'bg-red-500' : 'bg-green-500'} z-50 fixed top-4 left-1/2 transform -translate-x-1/2 w-[90%] md:w-auto shadow-xl transition-all duration-300`;
            setTimeout(() => { box.className = 'hidden'; }, 4000);
        }

        function switchTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.sidebar-link').forEach(el => el.classList.remove('active'));
            document.getElementById('tab-' + tabId).classList.add('active');
            document.getElementById('nav-' + tabId).classList.add('active');
            
            const titles = { home: 'Live Campaigns', account: 'Account Manager', activity: 'Promoted Activity', wallet: 'Wallet & Withdrawals' };
            document.getElementById('header-title').innerText = titles[tabId];
            if(window.innerWidth < 768) toggleSidebar();
        }

        auth.onAuthStateChanged(user => {
            if (user) {
                currentUser = user;
                document.getElementById('auth-section').classList.add('hidden');
                document.getElementById('sidebar').classList.remove('hidden');
                document.getElementById('main-content').classList.remove('hidden');
                document.getElementById('user-email-display').innerText = user.email;
                loadData();
            } else {
                document.getElementById('auth-section').classList.remove('hidden');
                document.getElementById('sidebar').classList.add('hidden');
                document.getElementById('main-content').classList.add('hidden');
            }
        });

        function signup() {
            auth.createUserWithEmailAndPassword(document.getElementById('email').value, document.getElementById('password').value)
                .then(cred => db.ref('users/' + cred.user.uid).set({ email: cred.user.email, wallet: 0, igStatus: 'none' }))
                .catch(err => alert(err.message));
        }

        function login() {
            auth.signInWithEmailAndPassword(document.getElementById('email').value, document.getElementById('password').value)
                .catch(err => alert(err.message));
        }
        function logout() { auth.signOut(); }

        function loadData() {
            db.ref('users/' + currentUser.uid).on('value', snap => {
                userData = snap.val();
                if(!userData) return;

                const walletBal = parseFloat(userData.wallet || 0).toFixed(2);
                document.getElementById('header-wallet').innerText = walletBal;
                document.getElementById('wallet-huge').innerText = walletBal;

                ['step-1', 'step-2', 'step-3', 'step-4'].forEach(id => document.getElementById(id).classList.add('hidden'));
                if(!userData.igStatus || userData.igStatus === 'none' || userData.igStatus === 'rejected') {
                    document.getElementById('step-1').classList.remove('hidden');
                } else if(userData.igStatus === 'waiting') {
                    document.getElementById('step-2').classList.remove('hidden');
                } else if(userData.igStatus === 'code_provided') {
                    document.getElementById('step-3').classList.remove('hidden');
                    document.getElementById('secret-code').innerText = userData.secretCode;
                } else if(userData.igStatus === 'verified') {
                    document.getElementById('step-4').classList.remove('hidden');
                }

                loadMyActivity(userData.reels || {});
            });

            db.ref('campaigns').on('value', snap => {
                const campaigns = snap.val() || {};
                const container = document.getElementById('campaigns-container');
                container.innerHTML = '';
                
                for(let key in campaigns) {
                    let c = campaigns[key];
                    if(c.status !== 'Running') continue; 

                    let maxAllowed = c.maxReels || 1; // Default to 1 if not set

                    container.innerHTML += `
                        <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden hover:shadow-lg transition relative">
                            <span class="absolute top-0 right-0 bg-yellow-400 text-yellow-900 text-[10px] font-black px-3 py-1 rounded-bl-lg">MAX ${maxAllowed} REELS</span>
                            <div class="p-5 mt-2">
                                <h4 class="text-lg font-bold text-gray-800 mb-2">${c.title}</h4>
                                <p class="text-sm text-gray-600 mb-3 line-clamp-2">${c.description}</p>
                                <div class="bg-indigo-50 border border-indigo-100 rounded-lg p-3 mb-4 flex justify-between items-center">
                                    <div>
                                        <p class="text-sm font-bold text-indigo-800">₹${c.price} / 1M Views</p>
                                        <p class="text-xs text-indigo-600 mt-1">Target: ${c.targetViews} Views</p>
                                    </div>
                                </div>
                                <div class="flex gap-2 mb-4">
                                    <a href="${c.logoUrl}" target="_blank" class="flex-1 text-center bg-gray-900 text-white text-xs font-bold py-2 rounded">Logo</a>
                                    <a href="${c.reqScreenshot}" target="_blank" class="flex-1 text-center bg-gray-100 text-gray-800 border text-xs font-bold py-2 rounded">Require</a>
                                </div>
                                <input type="url" id="reel-${key}" placeholder="Insta Reel Link" class="w-full border p-2 mb-2 rounded text-sm outline-none focus:ring-1 focus:ring-indigo-500">
                                <button onclick="submitReel('${key}', \`${c.title}\`, ${c.price}, ${maxAllowed})" class="w-full bg-indigo-600 text-white font-bold py-2 rounded text-sm shadow hover:bg-indigo-700 transition">Submit Reel</button>
                            </div>
                        </div>
                    `;
                }
            });
        }

        function submitIgLink() {
            const link = document.getElementById('ig-url').value;
            const igRegex = /instagram\.com\/[a-zA-Z0-9_.]+/i; 
            if(!igRegex.test(link)) return showAlert("Invalid Instagram Profile Link!");
            db.ref('users/' + currentUser.uid).update({ igLink: link, igStatus: 'waiting' });
            showAlert("Profile submitted for review!", "success");
        }

        function verifyCode() {
            document.getElementById('verify-btn').classList.add('hidden');
            document.getElementById('verify-loading').classList.remove('hidden');
            setTimeout(() => {
                db.ref('users/' + currentUser.uid).update({ igStatus: 'verified' });
                showAlert("Profile Verified Successfully!", "success");
            }, 5000);
        }

        // UPGRADED: Max Reels Validation
        function submitReel(campaignId, title, price, maxReelsAllowed) {
            if(userData.igStatus !== 'verified') return showAlert("Please link & verify your Instagram account first!");
            
            const reelUrl = document.getElementById(`reel-${campaignId}`).value;
            const reelRegex = /instagram\.com\/(reel|reels|p|share)\/[a-zA-Z0-9_-]+/i;
            if(!reelRegex.test(reelUrl)) return showAlert("Invalid Reel URL!");

            // Check how many reels user has already submitted for this campaign
            let existingReelsCount = 0;
            if (userData.reels) {
                for (let rId in userData.reels) {
                    if (userData.reels[rId].campaignId === campaignId) {
                        existingReelsCount++;
                    }
                }
            }

            if (existingReelsCount >= maxReelsAllowed) {
                return showAlert(`Limit Reached! You can only submit a maximum of ${maxReelsAllowed} reel(s) for this campaign.`, "error");
            }

            const reelId = 'reel_' + Date.now();
            db.ref(`users/${currentUser.uid}/reels/${reelId}`).set({
                url: reelUrl, campaignId: campaignId, campaignTitle: title, views: 0, status: 'Active', 
                ratePerMillion: price, earnedAmount: 0
            });
            document.getElementById(`reel-${campaignId}`).value = '';
            showAlert("Reel submitted successfully!", "success");
        }

        function loadMyActivity(reels) {
            const list = document.getElementById('my-reels-list');
            list.innerHTML = '';
            for(let key in reels) {
                let r = reels[key];
                let statusBadge = r.status === 'Completed' ? '<span class="bg-green-100 text-green-700 px-2 py-1 rounded text-xs font-bold w-full inline-block text-center">Paid & Completed</span>' : '<span class="bg-blue-100 text-blue-700 px-2 py-1 rounded text-xs font-bold w-full inline-block text-center">Active</span>';
                
                list.innerHTML += `
                    <tr>
                        <td class="p-3 md:p-4"><a href="${r.url}" target="_blank" class="text-indigo-600 hover:underline"><i class="fa-brands fa-instagram mr-1"></i>Link</a></td>
                        <td class="p-3 md:p-4 text-gray-700 max-w-[120px] truncate" title="${r.campaignTitle}">${r.campaignTitle}</td>
                        <td class="p-3 md:p-4 font-black">${Number(r.views).toLocaleString()}</td>
                        <td class="p-3 md:p-4 text-right font-bold ${r.earnedAmount > 0 ? 'text-green-600' : 'text-gray-500'}">₹${(r.earnedAmount||0).toFixed(2)}</td>
                        <td class="p-3 md:p-4">${statusBadge}</td>
                    </tr>
                `;
            }
        }

        function requestWithdrawal() {
            const reqAmount = parseInt(document.getElementById('withdraw-amount').value);
            const upi = document.getElementById('upi-id').value;

            if(isNaN(reqAmount) || reqAmount < 4000) return showAlert("Minimum withdrawal amount is ₹4000.");
            if(reqAmount > (userData.wallet || 0)) return showAlert("Insufficient wallet balance!");
            if(!upi || !upi.includes('@')) return showAlert("Please enter a valid UPI ID.");

            const reqId = 'with_' + Date.now();
            db.ref(`users/${currentUser.uid}/withdrawals/${reqId}`).set({
                amount: reqAmount, upi: upi, status: 'Pending', date: new Date().toLocaleString()
            });
            
            db.ref(`users/${currentUser.uid}`).update({ wallet: userData.wallet - reqAmount });
            
            document.getElementById('withdraw-amount').value = '';
            document.getElementById('upi-id').value = '';
            showAlert(`₹${reqAmount} Withdrawal requested successfully!`, "success");
        }
    </script>
</body>
</html>
